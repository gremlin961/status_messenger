<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Messenger Test</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Live Status Updates</h1>
        <p>This page demonstrates the status-messenger packages in action.</p>
        
        <button id="triggerWorkButton">Start Simulated Work</button>
        
        <h2>Current Status:</h2>
        <div id="status-display">Waiting for application to start or first status...</div>
    </div>

    <!--
      Assuming 'status-messenger' npm package is installed in a node_modules
      directory relative to this test project, or linked.
      For a simple test without bundling, we might copy the file or use a relative path.
      However, to "use the npm package", we'd typically bundle.
      For this example, we'll assume a bundler makes `startStatusUpdates` available,
      or it's loaded globally from a local `node_modules` copy.

      Simplest approach for this test (if not bundling):
      1. Create a package.json in 'test/'
      2. Run `npm install ../status_messenger_js` from 'test/' (to install local package)
      3. Then the script could be <script type="module"> import { startStatusUpdates } from './node_modules/status-messenger/index.js'; </script>
         (Path to node_modules might vary based on server setup)
      OR copy status_messenger_js/index.js to test/static/status-messenger.js and use:
      <script src="/static/status-messenger.js"></script>
    -->
    <script src="/static/status-messenger.js"></script> <!-- We will copy the file here for simplicity -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const statusDisplayElementId = 'status-display';
            const statusEndpoint = '/status'; // Flask endpoint
            const triggerWorkButton = document.getElementById('triggerWorkButton');

            // Check if the startStatusUpdates function is available
            if (typeof startStatusUpdates === 'function') {
                // Start polling for status updates
                const stopUpdates = startStatusUpdates(statusDisplayElementId, statusEndpoint, 1000); // Poll every 1 second
                console.log("Status updates initialized.");

                // Add event listener for the button
                triggerWorkButton.addEventListener('click', async () => {
                    triggerWorkButton.disabled = true;
                    triggerWorkButton.textContent = 'Work in Progress...';
                    try {
                        const response = await fetch('/simulate_work', { method: 'POST' });
                        const data = await response.json();
                        console.log(data.message);
                        if (!response.ok && response.status === 409) { // Conflict, work already running
                             // The status display should reflect this from polling
                        }
                    } catch (error) {
                        console.error('Error triggering work:', error);
                        document.getElementById(statusDisplayElementId).textContent = 'Error triggering work. See console.';
                    } finally {
                        // Re-enable button after a delay, or based on status
                        setTimeout(() => {
                            triggerWorkButton.disabled = false;
                            triggerWorkButton.textContent = 'Start Simulated Work';
                        }, 3000); // Arbitrary delay, real app might use status
                    }
                });

            } else {
                console.error('startStatusUpdates function not found. Make sure status-messenger.js is loaded correctly.');
                document.getElementById(statusDisplayElementId).textContent = 'Error: Status display script not loaded.';
            }
        });
    </script>
    <div class="footer">
        Test application using status-messenger packages.
    </div>
</body>
</html>
